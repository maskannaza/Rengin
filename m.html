<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp OTP (Iraq Only) - VerifyWay Test</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --muted:#9fb0d0; --text:#eaf0ff;
      --ok:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; --btn:#2563eb;
      --input:#0b1430; --border:#203055;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:linear-gradient(180deg,#060a14, #0b1220);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .wrap{width:min(980px,100%);display:grid;gap:16px;grid-template-columns:1fr}
    .card{background:rgba(16,26,51,.92);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:20px}
    .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.6}
    label{display:block;margin:10px 0 6px;color:#cfe0ff;font-size:13px}
    input{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);
      background:var(--input);color:var(--text);outline:none;
    }
    input:focus{border-color:#3557a8}
    .row{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:760px){ .row{grid-template-columns:1fr 1fr} }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      padding:11px 14px;border-radius:12px;border:1px solid transparent;background:var(--btn);
      color:white;font-weight:700;cursor:pointer;transition:.15s;min-width:160px
    }
    button:hover{transform:translateY(-1px);filter:brightness(1.06)}
    button:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .ghost{background:transparent;border-color:var(--border);color:#cfe0ff}
    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:#cfe0ff}
    .pill.ok{border-color:rgba(45,212,191,.35);color:#a7fff4}
    .pill.bad{border-color:rgba(251,113,133,.35);color:#ffd0d8}
    .out{
      background:#060a14;border:1px solid var(--border);border-radius:14px;
      padding:12px;min-height:140px;white-space:pre-wrap;word-break:break-word;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;line-height:1.55;color:#dbe7ff
    }
    .warnBox{margin-top:12px;border:1px dashed rgba(251,191,36,.5);border-radius:14px;padding:10px;color:#ffe7b0;background:rgba(251,191,36,.08);font-size:12px;line-height:1.6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ØªÛØ³ØªÛŒ WhatsApp OTP (ØªÛ•Ù†ÛŒØ§ Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¹ÛØ±Ø§Ù‚)</h1>
      <p class="sub">
        Ú˜Ù…Ø§Ø±Û• Ø¨Ù†ÙˆØ³Û• (07â€¦ ÛŒØ§Ù† +9647â€¦ ÛŒØ§Ù† 9647â€¦). Ø³ÛŒØ³ØªÛ•Ù… Ø®Û†Ú©Ø§Ø± Ø¯Û•Ú©Ø§Øª Ø¨Û• +964.<br/>
        Ø¯ÙˆØ§ØªØ± â€œÙ†Ø§Ø±Ø¯Ù†ÛŒ Ú©Û†Ø¯â€ Ø¨Ú©Û•. Ú©Ø§ØªÛÚ© Ú©Û†Ø¯ Ú¯Û•ÛŒØ´ØªØŒ Ù„Û• Ø®Ø§Ù†Û•ÛŒ OTP Ø¨Ù†ÙˆØ³Û• Ùˆ â€œVerifyâ€ Ø¨Ú©Û•.
      </p>

      <div class="row">
        <div>
          <label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…Û†Ø¨Ø§ÛŒÙ„ (Iraq Only)</label>
          <input id="phone" inputmode="tel" placeholder="07xxxxxxxxx  |  +9647xxxxxxxxx" autocomplete="tel" />
          <div class="hint">
            <span id="phoneStatus" class="pill">Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒâ€¦</span>
            <span class="pill">Ù¾ÛÙˆÛŒØ³Øª: +9647XXXXXXXXX</span>
          </div>
        </div>

        <div>
          <label>OTP Code (6 Ú˜Ù…Ø§Ø±Û•)</label>
          <input id="otp" inputmode="numeric" maxlength="6" placeholder="123456" autocomplete="one-time-code" />
          <div class="hint">Ø¦Û•Ú¯Û•Ø± Ú©Û†Ø¯ 4 Ú˜Ù…Ø§Ø±Û• Ø¨ÙˆÙˆØŒ Ø¦Û•Ù… maxlength Ù€Û• Ø¯Û•ØªÙˆØ§Ù†ÛŒØª Ø¨Ú¯Û†Ú•ÛŒØª.</div>
        </div>
      </div>

      <div class="actions">
        <button id="sendBtn" disabled>Ù†Ø§Ø±Ø¯Ù†ÛŒ Ú©Û†Ø¯ Ù„Û• WhatsApp</button>
        <button id="verifyBtn" class="ghost" disabled>Verify Ú©Û†Ø¯</button>
        <button id="clearBtn" class="ghost">Ù¾Ø§Ú©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•</button>
      </div>

      <div class="warnBox">
        âš ï¸ ØªÛØ¨ÛŒÙ†ÛŒ: Ø¯Ø§Ù†Ø§Ù†ÛŒ API Key Ù„Û• ÙØ±Û†Ù†Øª-Ø¦ÛÙ†Ø¯Ø¯Ø§ Ù…Û•ØªØ±Ø³ÛŒØ¯Ø§Ø±Û• (Ù‡Û•Ø± Ú©Û•Ø³ Ø¯Û•ØªÙˆØ§Ù†ÛØª Ø¨Ø¨ÛŒÙ†ÛØª). Ø¨Û† Ù¾Ø±Û†Ø¯Ú©Ø´Ù† Ø¨Ø§Ø´ØªØ±Û• Ù„Û•Ø³Û•Ø± Ø³ÛØ±Ú¤Û•Ø±/Proxy Ø¨ÛØª.
        Ù‡Û•Ø±ÙˆÛ•Ù‡Ø§ Ø¦Û•Ú¯Û•Ø± API CORS Ú•ÛÚ¯Ø§ÛŒ Ù†Û•Ø¯Ø§ØŒ Ù„Û• Ø¨Ø±Ø§ÙˆØ²Û•Ø±Û•ÙˆÛ• Ú•Ø§Ø³ØªÛ•ÙˆØ®Û† Ù†Ø§Ú†ÛØª.
      </div>
    </div>

    <div class="card">
      <h1>ÙˆÛ•ÚµØ§Ù…ÛŒ API</h1>
      <div id="out" class="out">-</div>
    </div>
  </div>

<script>
  // =========================
  // âœ… VerifyWay Settings
  // =========================
  const API_URL = "https://api.verifyway.com/api/v1/";
  const API_KEY = "786$shgkebsLP834tV3aCfQ8TydNQiYfHNQnA9fF"; // ğŸ”¥ Ù„Û• Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ ØªÛ†: Ù„Û•Ù†Ø§Ùˆ Ú©ÙˆØ¯Û•Ú©Û•

  // =========================
  // UI refs
  // =========================
  const elPhone = document.getElementById("phone");
  const elOtp   = document.getElementById("otp");
  const sendBtn = document.getElementById("sendBtn");
  const verifyBtn = document.getElementById("verifyBtn");
  const clearBtn = document.getElementById("clearBtn");
  const out = document.getElementById("out");
  const phoneStatus = document.getElementById("phoneStatus");

  // =========================
  // Helpers
  // =========================
  function setOut(obj){
    if (typeof obj === "string") out.textContent = obj;
    else out.textContent = JSON.stringify(obj, null, 2);
  }

  // Normalize IRAQ numbers to E.164 +9647xxxxxxxxx
  function normalizeIraq(raw){
    if(!raw) return { ok:false, msg:"Ú˜Ù…Ø§Ø±Û• Ø¨Ù†ÙˆØ³Û•", e164:null, digits:null };

    let s = raw.trim().replace(/\s+/g,"").replace(/[()-]/g,"");

    // allow leading +
    // Cases:
    // 1) 07xxxxxxxxx  -> +9647xxxxxxxxx
    // 2) 7xxxxxxxxx   -> +9647xxxxxxxxx (rare user input)
    // 3) 9647xxxxxxxxx -> +9647xxxxxxxxx
    // 4) +9647xxxxxxxxx -> +9647xxxxxxxxx
    if (s.startsWith("00")) s = "+" + s.slice(2);

    if (s.startsWith("+964")) {
      // ok
    } else if (s.startsWith("964")) {
      s = "+" + s;
    } else if (s.startsWith("0")) {
      // 07xxxxxxxxx
      s = "+964" + s.slice(1);
    } else if (s.startsWith("7")) {
      s = "+964" + s;
    } else {
      return { ok:false, msg:"ØªÛ•Ù†ÛŒØ§ Ú˜Ù…Ø§Ø±Û•ÛŒ Ø¹ÛØ±Ø§Ù‚ Ù‚Ø¨ÙˆÚµÛ• (+964â€¦ ÛŒØ§Ù† 07â€¦)", e164:null, digits:null };
    }

    // Iraq mobile commonly: +9647 + 9 digits => +9647xxxxxxxxx (13 chars incl +)
    const re = /^\+9647\d{9}$/;
    if (!re.test(s)) {
      return { ok:false, msg:"ÙÛ†Ø±Ù…Ø§Øª Ù‡Û•ÚµÛ•ÛŒÛ•. Ù†Ù…ÙˆÙˆÙ†Û•: 07xxxxxxxxx ÛŒØ§Ù† +9647xxxxxxxxx", e164:null, digits:null };
    }

    // API examples use digits only (no +)
    const digits = s.replace("+", ""); // 9647xxxxxxxxx
    return { ok:true, msg:"Ú˜Ù…Ø§Ø±Û• Ø¯Ø±ÙˆØ³ØªÛ• âœ…", e164:s, digits };
  }

  function updateState(){
    const n = normalizeIraq(elPhone.value);
    phoneStatus.textContent = n.ok ? `âœ… ${n.e164}` : `âŒ ${n.msg}`;
    phoneStatus.className = "pill " + (n.ok ? "ok" : "bad");

    sendBtn.disabled = !n.ok;
    verifyBtn.disabled = !(n.ok && (elOtp.value.trim().length >= 4));
  }

  elPhone.addEventListener("input", updateState);
  elOtp.addEventListener("input", () => {
    // keep digits only
    elOtp.value = elOtp.value.replace(/\D/g,"").slice(0, 6);
    updateState();
  });

  clearBtn.addEventListener("click", () => {
    elPhone.value = "";
    elOtp.value = "";
    setOut("-");
    updateState();
  });

  async function callVerifyWay(payload){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + API_KEY,
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    return { ok: res.ok, status: res.status, data };
  }

  // =========================
  // Actions
  // =========================
  sendBtn.addEventListener("click", async () => {
    const n = normalizeIraq(elPhone.value);
    if(!n.ok) return;

    setOut("â³ Ù†Ø§Ø±Ø¯Ù†...");

    // NOTE: based on your curl (with trailing comma fixed)
    const payload = {
      recipient: n.digits,      // "9647xxxxxxxxx"
      type: "otp",
      channel: "whatsapp"
      // you can add: lang:"en", fallback:"no" if your plan supports it
    };

    try{
      const r = await callVerifyWay(payload);
      setOut({
        action: "send_otp_whatsapp",
        payload,
        http_status: r.status,
        response: r.data
      });
    }catch(err){
      setOut("âŒ Ù‡Û•ÚµÛ•: " + (err?.message || err));
    }
  });

  verifyBtn.addEventListener("click", async () => {
    const n = normalizeIraq(elPhone.value);
    const code = elOtp.value.trim();
    if(!n.ok) return;
    if(code.length < 4) return setOut("âŒ Ú©Û†Ø¯ÛŒ OTP Ø¨Ù†ÙˆØ³Û•.");

    setOut("â³ Verify...");

    // Your curl includes "code" in the same endpoint.
    const payload = {
      recipient: n.digits,
      type: "otp",
      channel: "whatsapp",
      code: code
    };

    try{
      const r = await callVerifyWay(payload);
      setOut({
        action: "verify_otp",
        payload,
        http_status: r.status,
        response: r.data
      });
    }catch(err){
      setOut("âŒ Ù‡Û•ÚµÛ•: " + (err?.message || err));
    }
  });

  // init
  updateState();
</script>
</body>
</html>